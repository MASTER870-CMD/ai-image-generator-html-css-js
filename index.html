<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ATELIER ULTIMATE | Premium Textile Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-deep: #08080a;
            --bg-panel: rgba(18, 18, 24, 0.75);
            --bg-input: rgba(0,0,0,0.4);
            --accent: #d4af37; /* Royal Gold */
            --accent-glow: rgba(212, 175, 55, 0.4);
            --text-main: #f0f0f0;
            --text-muted: #888899;
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --radius: 8px;
            --blur: blur(25px);
            --sidebar-w: 360px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            height: 100vh;
            display: flex;
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 15% 50%, rgba(212, 175, 55, 0.04) 0%, transparent 25%),
                linear-gradient(to bottom, #050507, #0d0d12);
        }

        /* --- UI COMPONENTS --- */
        
        /* 1. Sidebar */
        aside {
            width: var(--sidebar-w);
            height: 100%;
            background: var(--bg-panel);
            backdrop-filter: var(--blur);
            border-right: var(--border);
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: absolute;
            left: 0; top: 0;
        }

        .brand {
            padding: 25px;
            font-family: 'Cinzel', serif;
            font-size: 1.4rem;
            color: var(--accent);
            letter-spacing: 2px;
            border-bottom: var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scroll-area {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .scroll-area::-webkit-scrollbar { width: 4px; }
        .scroll-area::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }

        /* Controls */
        .group { margin-bottom: 25px; }
        .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
        }

        textarea {
            width: 100%;
            background: var(--bg-input);
            border: var(--border);
            color: white;
            padding: 12px;
            border-radius: var(--radius);
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            transition: 0.3s;
        }
        textarea:focus { border-color: var(--accent); box-shadow: 0 0 10px var(--accent-glow); }

        .chip-grid { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip {
            font-size: 0.75rem;
            padding: 6px 12px;
            background: rgba(255,255,255,0.05);
            border-radius: 20px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid transparent;
        }
        .chip:hover { background: rgba(255,255,255,0.1); }
        .chip.active { background: rgba(212, 175, 55, 0.2); border-color: var(--accent); color: var(--accent); }

        .slider-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        input[type=range] {
            flex: 1; height: 4px; background: #333; border-radius: 2px; appearance: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer;
        }

        .btn-row { display: flex; gap: 10px; }
        .btn-small {
            flex: 1; padding: 8px; background: rgba(255,255,255,0.05); border: var(--border);
            color: #ccc; border-radius: 4px; cursor: pointer; font-size: 0.75rem; transition: 0.2s;
        }
        .btn-small:hover, .btn-small.active { background: var(--accent); color: #000; font-weight: bold; }

        /* The Skippers (Filter Sliders) */
        .skipper-box {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: var(--radius);
            border: var(--border);
        }

        /* Footer Action */
        .action-area {
            padding: 20px;
            background: var(--bg-panel);
            border-top: var(--border);
        }
        
        .btn-main {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--accent), #8a7020);
            color: #000;
            border: none;
            border-radius: var(--radius);
            font-weight: 700;
            font-size: 0.95rem;
            letter-spacing: 1px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            transition: 0.2s;
        }
        .btn-main:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,0,0,0.4); }
        .btn-main:disabled { filter: grayscale(1); opacity: 0.7; cursor: not-allowed; }

        /* 2. Main Stage */
        main {
            flex: 1;
            margin-left: var(--sidebar-w); /* Desktop default */
            position: relative;
            display: flex;
            flex-direction: column;
            background-image: linear-gradient(#1a1a1a 1px, transparent 1px), linear-gradient(90deg, #1a1a1a 1px, transparent 1px);
            background-size: 40px 40px;
            transition: margin 0.3s;
        }

        .toolbar-top {
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
        }
        
        .tool-group { display: flex; gap: 10px; background: rgba(0,0,0,0.6); padding: 5px; border-radius: 30px; backdrop-filter: blur(10px); border: var(--border); }
        
        .icon-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: none;
            background: transparent;
            color: #fff;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.1); color: var(--accent); }

        .canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }

        /* Image Wrapper for Filters */
        #imgWrapper {
            transition: transform 0.2s;
            box-shadow: 0 30px 60px rgba(0,0,0,0.5);
            max-width: 100%; max-height: 100%;
        }
        
        #mainImg {
            display: block;
            max-width: 100%;
            max-height: 80vh; /* dynamic */
            object-fit: contain;
            border-radius: 4px;
        }

        .loader-overlay {
            position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.7);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 60;
            backdrop-filter: blur(5px);
        }
        .loading-bar-wrap { width: 200px; height: 4px; background: #333; margin-top: 15px; border-radius: 2px; overflow:hidden; }
        .loading-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0.3s; }

        /* 3. History Strip */
        .history-strip {
            height: 110px;
            background: var(--bg-panel);
            border-top: var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 15px;
            overflow-x: auto;
            backdrop-filter: blur(20px);
        }
        .h-item {
            min-width: 80px; height: 80px;
            border-radius: 6px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: pointer;
            position: relative;
            transition: 0.2s;
        }
        .h-item img { width: 100%; height: 100%; object-fit: cover; }
        .h-item:hover, .h-item.active { border-color: var(--accent); transform: translateY(-3px); }
        .h-btn-del {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.7); color: #ff4444;
            border: none; width: 20px; height: 20px; border-radius: 50%;
            display: none; cursor: pointer; font-size: 10px;
        }
        .h-item:hover .h-btn-del { display: flex; align-items: center; justify-content: center; }

        /* Menu Toggle (Mobile) */
        .menu-toggle {
            display: none;
            position: fixed; top: 15px; left: 15px; z-index: 200;
            background: var(--bg-panel); border: var(--border); color: var(--accent);
            padding: 10px; border-radius: 8px; cursor: pointer;
        }

        /* Modal/Lightbox */
        .lightbox {
            position: fixed; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.95); z-index: 300;
            display: none; justify-content: center; align-items: center;
        }
        .lightbox img { max-width: 95%; max-height: 95%; border: 2px solid #333; }
        .close-lb { position: absolute; top: 20px; right: 20px; color: #fff; font-size: 2rem; cursor: pointer; }

        /* Notification */
        .toast {
            position: fixed; bottom: 130px; left: 50%; transform: translateX(-50%) translateY(20px);
            background: var(--accent); color: #000;
            padding: 10px 20px; border-radius: 20px; font-weight: 600;
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            aside { transform: translateX(-100%); width: 300px; }
            aside.open { transform: translateX(0); box-shadow: 10px 0 50px rgba(0,0,0,0.5); }
            main { margin-left: 0; }
            .menu-toggle { display: block; }
            .toolbar-top { padding: 10px; }
            .tool-group span { display: none; } /* hide text on mobile */
        }
    </style>
</head>
<body>

    <button class="menu-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>

    <aside id="sidebar">
        <div class="brand">
            <span>ATELIER <small style="font-size:0.5em; opacity:0.6;">ULTIMATE</small></span>
            <button class="icon-btn" onclick="randomizeAll()" title="I'm feeling lucky"><i class="fa-solid fa-dice"></i></button>
        </div>

        <div class="scroll-area">
            <div class="group">
                <div class="label">Vision / Prompt</div>
                <textarea id="promptInput" placeholder="Describe the texture... (e.g. Royal red velvet with golden floral embroidery)"></textarea>
                <div style="margin-top:8px; display:flex; gap:10px;">
                    <div class="chip" id="enhanceBtn" onclick="toggleEnhance()" style="border: 1px solid var(--accent);">Magic Enhance: ON</div>
                    <input type="color" id="colorPicker" value="#d4af37" title="Pick Accent Color" style="height:30px; width:30px; border:none; background:none; cursor:pointer;">
                </div>
            </div>

            <div class="group">
                <div class="label">Material Fabric</div>
                <div class="chip-grid" id="materialGrid">
                    </div>
            </div>

            <div class="group">
                <div class="label">Weave Pattern</div>
                <select id="patternSelect" style="width:100%; background:var(--bg-input); color:#fff; padding:10px; border:var(--border); border-radius:4px;">
                    <option value="">None / Custom</option>
                    <option value="Damask">Damask</option>
                    <option value="Paisley">Paisley</option>
                    <option value="Herringbone">Herringbone</option>
                    <option value="Tartan">Tartan / Plaid</option>
                    <option value="Geometric">Geometric Bauhaus</option>
                    <option value="Floral">Botanical Floral</option>
                    <option value="Brocade">Heavy Brocade</option>
                    <option value="Knitted">Cable Knit</option>
                </select>
            </div>

            <div class="group">
                <div class="label">Dimensions <span id="dimDisplay">1024 x 1024</span></div>
                <div class="btn-row" style="margin-bottom:10px;">
                    <div class="btn-small active" onclick="setRatio(1024,1024, this)">1:1</div>
                    <div class="btn-small" onclick="setRatio(1024,1280, this)">3:4</div>
                    <div class="btn-small" onclick="setRatio(1280,720, this)">16:9</div>
                    <div class="btn-small" onclick="setRatio(720,1280, this)">9:16</div>
                </div>
                <div class="slider-row">
                    <span style="font-size:0.7rem; width:10px;">W</span>
                    <input type="range" id="widthRange" min="256" max="1400" step="32" value="1024">
                </div>
                <div class="slider-row">
                    <span style="font-size:0.7rem; width:10px;">H</span>
                    <input type="range" id="heightRange" min="256" max="1400" step="32" value="1024">
                </div>
                <div class="label" style="margin-top:10px; cursor:pointer;" onclick="toggleAdvanced()">
                    Advanced Settings <i class="fa-solid fa-chevron-down"></i>
                </div>
                <div id="advancedArea" style="display:none; padding-left:10px; border-left: 2px solid #333; margin-top:5px;">
                    <div class="slider-row">
                        <span style="font-size:0.7rem;">Seed</span>
                        <input type="number" id="seedInput" value="42" style="width:60px; background:transparent; border:1px solid #444; color:#fff;">
                        <i class="fa-solid fa-arrows-rotate" style="font-size:0.8rem; cursor:pointer;" onclick="newSeed()"></i>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-top:5px;">
                        <label style="font-size:0.75rem;"><input type="checkbox" id="tileCheck"> Seamless Tile</label>
                        <label style="font-size:0.75rem;"><input type="checkbox" id="hdCheck" checked> HD Quality</label>
                    </div>
                </div>
            </div>

            <div class="group skipper-box">
                <div class="label" style="justify-content: space-between; display:flex;">
                    <span>Post-Processing</span>
                    <span style="cursor:pointer; color:var(--accent);" onclick="resetFilters()">Reset</span>
                </div>
                <div class="slider-row" title="Brightness">
                    <i class="fa-solid fa-sun" style="font-size:0.7rem;"></i>
                    <input type="range" id="fBright" min="50" max="150" value="100" oninput="applyFilters()">
                </div>
                <div class="slider-row" title="Contrast">
                    <i class="fa-solid fa-circle-half-stroke" style="font-size:0.7rem;"></i>
                    <input type="range" id="fContrast" min="50" max="150" value="100" oninput="applyFilters()">
                </div>
                <div class="slider-row" title="Saturation">
                    <i class="fa-solid fa-palette" style="font-size:0.7rem;"></i>
                    <input type="range" id="fSat" min="0" max="200" value="100" oninput="applyFilters()">
                </div>
            </div>

        </div>

        <div class="action-area">
            <button class="btn-main" id="generateBtn" onclick="generate()">
                <i class="fa-solid fa-wand-sparkles"></i> GENERATE
            </button>
        </div>
    </aside>

    <main onclick="closeSidebarMobile()">
        <div class="toolbar-top">
            <div class="tool-group">
                <button class="icon-btn" onclick="toggleFullscreen()" title="Fullscreen"><i class="fa-solid fa-expand"></i></button>
                <button class="icon-btn" onclick="openLightbox()" title="Zoom"><i class="fa-solid fa-magnifying-glass-plus"></i></button>
            </div>
            <div class="tool-group">
                <button class="icon-btn" onclick="copyPrompt()" title="Copy Prompt"><i class="fa-solid fa-copy"></i></button>
                <button class="icon-btn" onclick="flipImage('h')" title="Flip H"><i class="fa-solid fa-left-right"></i></button>
                <button class="icon-btn" onclick="downloadImage()" title="Download" style="color:var(--accent);"><i class="fa-solid fa-download"></i></button>
            </div>
        </div>

        <div class="canvas-area">
            <div id="emptyState" style="text-align:center; opacity:0.3;">
                <i class="fa-brands fa-codepen" style="font-size:5rem; margin-bottom:20px;"></i>
                <h2>Ready to Weave</h2>
            </div>

            <div id="imgWrapper">
                <img id="mainImg" src="" alt="">
            </div>

            <div class="loader-overlay" id="loader">
                <div style="font-family:'Cinzel'; color:var(--accent); letter-spacing:3px;" id="statusText">INITIALIZING</div>
                <div class="loading-bar-wrap">
                    <div class="loading-bar" id="progressBar"></div>
                </div>
            </div>
        </div>

        <div class="history-strip" id="historyStrip">
            </div>
    </main>

    <div class="toast" id="toast">Message</div>

    <div class="lightbox" id="lightbox">
        <span class="close-lb" onclick="closeLightbox()">&times;</span>
        <img id="lbImg" src="">
    </div>

    <canvas id="dlCanvas" style="display:none;"></canvas>

    <script>
        // --- CONSTANTS & STATE ---
        const MATERIALS = ['Silk', 'Velvet', 'Denim', 'Linen', 'Leather', 'Cotton', 'Wool', 'Satin', 'Brocade'];
        let selectedMaterial = 'Silk';
        let isEnhanceOn = true;
        let isGenerating = false;

        // --- DOM REFERENCES ---
        const els = {
            prompt: document.getElementById('promptInput'),
            matGrid: document.getElementById('materialGrid'),
            patSelect: document.getElementById('patternSelect'),
            wRange: document.getElementById('widthRange'),
            hRange: document.getElementById('heightRange'),
            dimDisp: document.getElementById('dimDisplay'),
            seed: document.getElementById('seedInput'),
            tile: document.getElementById('tileCheck'),
            hd: document.getElementById('hdCheck'),
            filters: {
                b: document.getElementById('fBright'),
                c: document.getElementById('fContrast'),
                s: document.getElementById('fSat')
            },
            mainImg: document.getElementById('mainImg'),
            imgWrapper: document.getElementById('imgWrapper'),
            loader: document.getElementById('loader'),
            bar: document.getElementById('progressBar'),
            status: document.getElementById('statusText'),
            history: document.getElementById('historyStrip'),
            toast: document.getElementById('toast'),
            btn: document.getElementById('generateBtn'),
            sidebar: document.getElementById('sidebar'),
            color: document.getElementById('colorPicker')
        };

        // --- INITIALIZATION ---
        window.addEventListener('load', () => {
            renderMaterials();
            updateDimDisplay();
            loadHistory();
            newSeed();
        });

        // --- CORE FUNCTIONS ---

        function renderMaterials() {
            els.matGrid.innerHTML = '';
            MATERIALS.forEach(m => {
                const chip = document.createElement('div');
                chip.className = `chip ${m === selectedMaterial ? 'active' : ''}`;
                chip.innerText = m;
                chip.onclick = () => {
                    document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    selectedMaterial = m;
                    // Auto-enhance prompt slightly on click
                    if(!els.prompt.value.includes(m)) {
                        els.prompt.value = `${m} fabric, ` + els.prompt.value;
                    }
                };
                els.matGrid.appendChild(chip);
            });
        }

        // --- GENERATION ENGINE ---
        function generate() {
            if(isGenerating) return;

            const basePrompt = els.prompt.value.trim();
            if(!basePrompt && !selectedMaterial) {
                showToast("Please enter a vision!");
                return;
            }

            isGenerating = true;
            els.btn.disabled = true;
            els.btn.innerHTML = 'WEAVING...';
            els.loader.style.display = 'flex';
            document.getElementById('emptyState').style.display = 'none';

            // Construct Prompt
            let prompt = `Textile texture, close up, ${basePrompt}`;
            if(selectedMaterial) prompt += `, ${selectedMaterial} material`;
            const pattern = els.patSelect.value;
            if(pattern) prompt += `, ${pattern} pattern`;
            
            // Color Injection
            prompt += `, dominant color ${els.color.value}`;

            if(isEnhanceOn) {
                prompt += ", 8k resolution, highly detailed fabric texture, photorealistic, cinematic lighting, sharp focus";
            }
            if(els.tile.checked) prompt += ", seamless repeating pattern";
            
            // Negatives
            prompt += " --no blur --no watermark --no text --no distortion";

            // URL Construction
            const w = els.wRange.value;
            const h = els.hRange.value;
            const seed = els.seed.value;
            const encoded = encodeURIComponent(prompt);
            
            const url = `https://image.pollinations.ai/prompt/${encoded}?width=${w}&height=${h}&seed=${seed}&nologo=true`;

            // Simulation
            simulateProgress();

            // Load Image
            const imgLoad = new Image();
            imgLoad.src = url;
            imgLoad.onload = () => {
                els.mainImg.src = url;
                // Store metadata
                els.mainImg.dataset.prompt = prompt;
                els.mainImg.dataset.seed = seed;
                
                finishGeneration(url);
            };
            imgLoad.onerror = () => {
                showToast("Weaving failed. Try again.");
                resetUI();
            };
        }

        function simulateProgress() {
            let p = 0;
            const stages = ["SOURCING THREADS", "DYING FIBERS", "SETTING LOOM", "WEAVING PATTERN", "FINAL STITCHING"];
            els.bar.style.width = '0%';
            
            const int = setInterval(() => {
                if(!isGenerating) { clearInterval(int); return; }
                p += Math.random() * 10;
                if(p > 90) p = 90;
                els.bar.style.width = p + '%';
                
                const idx = Math.floor((p/100) * stages.length);
                els.status.innerText = stages[Math.min(idx, stages.length-1)];
            }, 300);
        }

        function finishGeneration(url) {
            els.bar.style.width = '100%';
            els.status.innerText = "COMPLETE";
            setTimeout(() => {
                resetUI();
                saveToHistory(url, els.prompt.value);
                applyFilters(); // Re-apply current slider settings
            }, 600);
        }

        function resetUI() {
            isGenerating = false;
            els.loader.style.display = 'none';
            els.btn.disabled = false;
            els.btn.innerHTML = '<i class="fa-solid fa-wand-sparkles"></i> GENERATE';
        }

        // --- FILTERS & POST PROCESSING ---
        function applyFilters() {
            const b = els.filters.b.value;
            const c = els.filters.c.value;
            const s = els.filters.s.value;
            const filterString = `brightness(${b}%) contrast(${c}%) saturate(${s}%)`;
            els.imgWrapper.style.filter = filterString;
        }

        function resetFilters() {
            els.filters.b.value = 100;
            els.filters.c.value = 100;
            els.filters.s.value = 100;
            applyFilters();
        }

        function flipImage(dir) {
            const current = els.mainImg.style.transform || '';
            if(dir === 'h') {
                els.mainImg.style.transform = current.includes('scaleX(-1)') ? current.replace('scaleX(-1)', '') : current + ' scaleX(-1)';
            }
        }

        // --- UTILS & DOWNLOAD ---
        async function downloadImage() {
            const src = els.mainImg.src;
            if(!src) return;

            showToast("Processing Download...");

            try {
                // 1. Fetch original image to avoid CORS issues with Canvas
                const response = await fetch(src);
                const blob = await response.blob();
                const bitmap = await createImageBitmap(blob);

                // 2. Setup Canvas
                const cvs = document.getElementById('dlCanvas');
                const ctx = cvs.getContext('2d');
                cvs.width = bitmap.width;
                cvs.height = bitmap.height;

                // 3. Apply Filters (Ctx Filter)
                const b = els.filters.b.value;
                const c = els.filters.c.value;
                const s = els.filters.s.value;
                ctx.filter = `brightness(${b}%) contrast(${c}%) saturate(${s}%)`;

                // 4. Draw
                // Check if flipped
                const isFlipped = els.mainImg.style.transform.includes('scaleX(-1)');
                if(isFlipped) {
                    ctx.translate(cvs.width, 0);
                    ctx.scale(-1, 1);
                }

                ctx.drawImage(bitmap, 0, 0);

                // 5. Save
                const link = document.createElement('a');
                link.download = `Atelier_${Date.now()}.jpg`;
                link.href = cvs.toDataURL('image/jpeg', 0.95);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast("Image Saved!");

            } catch (err) {
                console.error(err);
                // Fallback: simple link
                const a = document.createElement('a');
                a.href = src;
                a.download = 'Textile.jpg';
                a.click();
            }
        }

        // --- HISTORY SYSTEM ---
        function saveToHistory(url, prompt) {
            const history = getHistory();
            const item = { url, prompt, date: Date.now(), seed: els.seed.value };
            history.unshift(item);
            if(history.length > 20) history.pop();
            localStorage.setItem('atelier_history_v2', JSON.stringify(history));
            renderHistory();
        }

        function getHistory() {
            return JSON.parse(localStorage.getItem('atelier_history_v2') || '[]');
        }

        function renderHistory() {
            els.history.innerHTML = '';
            const list = getHistory();
            list.forEach((item, idx) => {
                const div = document.createElement('div');
                div.className = 'h-item';
                div.innerHTML = `
                    <img src="${item.url}" loading="lazy">
                    <button class="h-btn-del" onclick="deleteHistory(event, ${idx})">âœ•</button>
                `;
                div.onclick = (e) => {
                    if(e.target.tagName !== 'BUTTON') loadHistoryItem(item);
                }
                els.history.appendChild(div);
            });
        }

        function loadHistoryItem(item) {
            els.mainImg.src = item.url;
            els.prompt.value = item.prompt;
            els.seed.value = item.seed || 42;
            document.getElementById('emptyState').style.display = 'none';
        }

        function deleteHistory(e, idx) {
            e.stopPropagation();
            const list = getHistory();
            list.splice(idx, 1);
            localStorage.setItem('atelier_history_v2', JSON.stringify(list));
            renderHistory();
        }

        function loadHistory() { renderHistory(); }

        // --- UI HELPERS ---
        function toggleSidebar() {
            els.sidebar.classList.toggle('open');
        }

        function closeSidebarMobile() {
            els.sidebar.classList.remove('open');
        }

        function updateDimDisplay() {
            els.dimDisp.innerText = `${els.wRange.value} x ${els.hRange.value}`;
        }
        
        els.wRange.addEventListener('input', updateDimDisplay);
        els.hRange.addEventListener('input', updateDimDisplay);

        function setRatio(w, h, btn) {
            els.wRange.value = w;
            els.hRange.value = h;
            updateDimDisplay();
            document.querySelectorAll('.btn-small').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleEnhance() {
            isEnhanceOn = !isEnhanceOn;
            document.getElementById('enhanceBtn').style.opacity = isEnhanceOn ? '1' : '0.5';
            document.getElementById('enhanceBtn').innerText = isEnhanceOn ? 'Magic Enhance: ON' : 'Magic Enhance: OFF';
        }

        function toggleAdvanced() {
            const area = document.getElementById('advancedArea');
            area.style.display = area.style.display === 'none' ? 'block' : 'none';
        }

        function newSeed() { els.seed.value = Math.floor(Math.random() * 999999); }

        function randomizeAll() {
            newSeed();
            const mats = document.querySelectorAll('.chip');
            mats[Math.floor(Math.random()*mats.length)].click();
            els.patSelect.selectedIndex = Math.floor(Math.random() * els.patSelect.options.length);
            showToast("Randomized Settings!");
        }

        function showToast(msg) {
            els.toast.textContent = msg;
            els.toast.classList.add('show');
            setTimeout(() => els.toast.classList.remove('show'), 3000);
        }

        function copyPrompt() {
            navigator.clipboard.writeText(els.prompt.value);
            showToast("Prompt Copied!");
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }

        // Lightbox
        function openLightbox() {
            if(!els.mainImg.src) return;
            document.getElementById('lbImg').src = els.mainImg.src;
            document.getElementById('lightbox').style.display = 'flex';
        }
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if(e.ctrlKey && e.key === 'Enter') generate();
        });

    </script>
</body>
</html>
